# ============================================================
# FlowNote â€“ Storage Network Access Schedule
#
# ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ãƒ‘ãƒ–ãƒªãƒƒã‚¯ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¢ã‚¯ã‚»ã‚¹ã‚’
# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ãŸã‚ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«åˆ¶å¾¡ã™ã‚‹ã€‚
#
# ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ« (JST, UTC+9):
#   æ¯Žæ™© 21:00 JST (12:00 UTC) â†’ publicNetworkAccess = Disabled
#   æ¯Žæœ 04:00 JST (19:00 UTC) â†’ publicNetworkAccess = Enabled
#
# å‚™è€ƒ:
#   - bypass: AzureServices ã¯å¸¸ã«æœ‰åŠ¹ã®ãŸã‚ã€Kudu / Function App ãƒ©ãƒ³ã‚¿ã‚¤ãƒ  /
#     Application Insights ç­‰ã® Azure å†…éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã¯ Disabled æ™‚ã‚‚ç¶™ç¶šã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã€‚
#   - release.yml ã® "Ensure storage public network access is Enabled" ã‚¹ãƒ†ãƒƒãƒ—ãŒ
#     ãƒ‡ãƒ—ãƒ­ã‚¤å‰ã«è‡ªå‹•ã§ Enabled ã«æˆ»ã™ãŸã‚ã€å¤œé–“ã« push ã—ã¦ã‚‚ CD ã¯æ­£å¸¸å‹•ä½œã™ã‚‹ã€‚
#   - workflow_dispatch ã§æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½ (action: enable | disable)ã€‚
#
# Required Secrets:
#   AZURE_CREDENTIALS        â€“ Service principal JSON
#   AZURE_SUBSCRIPTION_ID    â€“ (Optional) Target subscription
# ============================================================
name: Storage Network Access Schedule

on:
  schedule:
    # æ¯Žæ™© 21:00 JST = 12:00 UTC â†’ Disabled
    - cron: '0 12 * * *'
    # æ¯Žæœ 04:00 JST = 19:00 UTC â†’ Enabled
    - cron: '0 19 * * *'
  workflow_dispatch:
    inputs:
      action:
        description: 'å®Ÿè¡Œã™ã‚‹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³'
        required: true
        type: choice
        options:
          - enable
          - disable

env:
  RESOURCE_GROUP:       rg-flownote
  SUBSCRIPTION_ID:      ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  STORAGE_ACCOUNT_NAME: flownoteprodst   # Bicep: take(replace('flownoteprodst','-',''),24)

jobs:

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Disable public network access (21:00 JST)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  disable-public-access:
    name: ðŸ”’ Disable public network access (21:00 JST)
    runs-on: ubuntu-latest
    if: >-
      github.event.schedule == '0 12 * * *' ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'disable')

    steps:
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Disable public network access
        run: |
          SUBSCRIPTION_ARGS=()
          if [ -n "${{ env.SUBSCRIPTION_ID }}" ]; then
            SUBSCRIPTION_ARGS+=(--subscription "${{ env.SUBSCRIPTION_ID }}")
          fi
          az storage account update \
            --name "${{ env.STORAGE_ACCOUNT_NAME }}" \
            --resource-group "${{ env.RESOURCE_GROUP }}" \
            "${SUBSCRIPTION_ARGS[@]}" \
            --public-network-access Disabled \
            --bypass AzureServices Logging Metrics \
            --output none
          echo "ðŸ”’ publicNetworkAccess = Disabled"
          echo "âœ… bypass = AzureServices,Logging,Metrics (Azure å†…éƒ¨ã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹ã¯ç¶™ç¶šå¯èƒ½)"

      - name: Verify
        run: |
          SUBSCRIPTION_ARGS=()
          if [ -n "${{ env.SUBSCRIPTION_ID }}" ]; then
            SUBSCRIPTION_ARGS+=(--subscription "${{ env.SUBSCRIPTION_ID }}")
          fi
          RESULT=$(az storage account show \
            --name "${{ env.STORAGE_ACCOUNT_NAME }}" \
            --resource-group "${{ env.RESOURCE_GROUP }}" \
            "${SUBSCRIPTION_ARGS[@]}" \
            --query "{publicNetworkAccess: properties.publicNetworkAccess, bypass: properties.networkAcls.bypass}" \
            --output json)
          echo "$RESULT"
          echo "## Storage Network Access" >> "$GITHUB_STEP_SUMMARY"
          echo "| é …ç›® | å€¤ |" >> "$GITHUB_STEP_SUMMARY"
          echo "|------|-----|" >> "$GITHUB_STEP_SUMMARY"
          echo "| publicNetworkAccess | $(echo $RESULT | jq -r .publicNetworkAccess) |" >> "$GITHUB_STEP_SUMMARY"
          echo "| bypass | $(echo $RESULT | jq -r .bypass) |" >> "$GITHUB_STEP_SUMMARY"

      - name: Azure Logout
        if: always()
        run: az logout

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Enable public network access (04:00 JST)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  enable-public-access:
    name: ðŸ”“ Enable public network access (04:00 JST)
    runs-on: ubuntu-latest
    if: >-
      github.event.schedule == '0 19 * * *' ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'enable')

    steps:
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Enable public network access
        run: |
          SUBSCRIPTION_ARGS=()
          if [ -n "${{ env.SUBSCRIPTION_ID }}" ]; then
            SUBSCRIPTION_ARGS+=(--subscription "${{ env.SUBSCRIPTION_ID }}")
          fi
          az storage account update \
            --name "${{ env.STORAGE_ACCOUNT_NAME }}" \
            --resource-group "${{ env.RESOURCE_GROUP }}" \
            "${SUBSCRIPTION_ARGS[@]}" \
            --public-network-access Enabled \
            --bypass AzureServices Logging Metrics \
            --output none
          echo "ðŸ”“ publicNetworkAccess = Enabled"

      - name: Verify
        run: |
          SUBSCRIPTION_ARGS=()
          if [ -n "${{ env.SUBSCRIPTION_ID }}" ]; then
            SUBSCRIPTION_ARGS+=(--subscription "${{ env.SUBSCRIPTION_ID }}")
          fi
          RESULT=$(az storage account show \
            --name "${{ env.STORAGE_ACCOUNT_NAME }}" \
            --resource-group "${{ env.RESOURCE_GROUP }}" \
            "${SUBSCRIPTION_ARGS[@]}" \
            --query "{publicNetworkAccess: properties.publicNetworkAccess, bypass: properties.networkAcls.bypass}" \
            --output json)
          echo "$RESULT"
          echo "## Storage Network Access" >> "$GITHUB_STEP_SUMMARY"
          echo "| é …ç›® | å€¤ |" >> "$GITHUB_STEP_SUMMARY"
          echo "|------|-----|" >> "$GITHUB_STEP_SUMMARY"
          echo "| publicNetworkAccess | $(echo $RESULT | jq -r .publicNetworkAccess) |" >> "$GITHUB_STEP_SUMMARY"
          echo "| bypass | $(echo $RESULT | jq -r .bypass) |" >> "$GITHUB_STEP_SUMMARY"

      - name: Azure Logout
        if: always()
        run: az logout
